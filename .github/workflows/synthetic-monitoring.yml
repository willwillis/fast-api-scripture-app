name: Synthetic Monitoring

on:
  schedule:
    # Run every 15 minutes to keep service warm
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  warm-up-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10 # Allow up to 10 minutes for the job
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up environment
      run: |
        # Set your API URL here
        echo "API_URL=https://scriptures-fast-api.onrender.com" >> $GITHUB_ENV
        
    - name: Warm up service
      run: |
        echo "ğŸ”„ Starting service warm-up..."
        
        # Initial health check to trigger cold start
        echo "ğŸ“¡ Making initial health check request..."
        curl -s -w "Initial Response Time: %{time_total}s\n" \
          -o /dev/null \
          "$API_URL/health" || echo "Initial request failed (expected for cold start)"
        
        # Wait 5 minutes for service to fully warm up
        echo "â° Waiting 5 minutes for service to warm up..."
        sleep 300
        
        echo "âœ… Warm-up period complete"
        
    - name: Test core endpoints
      run: |
        echo "ğŸ§ª Testing core API endpoints..."
        
        # Test health endpoint
        echo "ğŸ“Š Testing health endpoint..."
        HEALTH_RESPONSE=$(curl -s -w "\nResponse Time: %{time_total}s\n" \
          "$API_URL/health")
        echo "$HEALTH_RESPONSE"
        
        # Test volumes endpoint
        echo "ğŸ“š Testing volumes endpoint..."
        VOLUMES_RESPONSE=$(curl -s -w "\nResponse Time: %{time_total}s\n" \
          "$API_URL/api/scriptures/volumes")
        echo "$VOLUMES_RESPONSE"
        
        # Test random scripture endpoint
        echo "ğŸ² Testing random scripture endpoint..."
        RANDOM_RESPONSE=$(curl -s -w "\nResponse Time: %{time_total}s\n" \
          "$API_URL/api/scriptures/random")
        echo "$RANDOM_RESPONSE"
        
        # Test search endpoint
        echo "ğŸ” Testing search endpoint..."
        SEARCH_RESPONSE=$(curl -s -w "\nResponse Time: %{time_total}s\n" \
          "$API_URL/api/scriptures/search?q=love&limit=5")
        echo "$SEARCH_RESPONSE"
        
    - name: Validate responses
      run: |
        echo "âœ… Validating API responses..."
        
        # Check if health endpoint returns healthy status
        HEALTH_STATUS=$(curl -s "$API_URL/health" | jq -r '.status')
        if [ "$HEALTH_STATUS" = "healthy" ]; then
          echo "âœ… Health check passed"
        else
          echo "âŒ Health check failed: $HEALTH_STATUS"
          exit 1
        fi
        
        # Check if volumes endpoint returns data
        VOLUMES_COUNT=$(curl -s "$API_URL/api/scriptures/volumes" | jq 'length')
        if [ "$VOLUMES_COUNT" -gt 0 ]; then
          echo "âœ… Volumes endpoint working: $VOLUMES_COUNT volumes found"
        else
          echo "âŒ Volumes endpoint failed"
          exit 1
        fi
        
        # Check if random endpoint returns scripture
        RANDOM_SCRIPTURE=$(curl -s "$API_URL/api/scriptures/random" | jq -r '.scripture_text')
        if [ -n "$RANDOM_SCRIPTURE" ]; then
          echo "âœ… Random scripture endpoint working"
        else
          echo "âŒ Random scripture endpoint failed"
          exit 1
        fi
        
    - name: Performance metrics
      run: |
        echo "ğŸ“ˆ Collecting performance metrics..."
        
        # Measure response times
        HEALTH_TIME=$(curl -s -w "%{time_total}" -o /dev/null "$API_URL/health")
        VOLUMES_TIME=$(curl -s -w "%{time_total}" -o /dev/null "$API_URL/api/scriptures/volumes")
        RANDOM_TIME=$(curl -s -w "%{time_total}" -o /dev/null "$API_URL/api/scriptures/random")
        
        echo "Health endpoint: ${HEALTH_TIME}s"
        echo "Volumes endpoint: ${VOLUMES_TIME}s"
        echo "Random endpoint: ${RANDOM_TIME}s"
        
        # Alert if response times are too slow
        if (( $(echo "$HEALTH_TIME > 5" | bc -l) )); then
          echo "âš ï¸ Health endpoint is slow: ${HEALTH_TIME}s"
        fi
        
        if (( $(echo "$RANDOM_TIME > 10" | bc -l) )); then
          echo "âš ï¸ Random endpoint is slow: ${RANDOM_TIME}s"
        fi
        
    - name: Success notification
      if: success()
      run: |
        echo "ğŸ‰ All synthetic tests passed!"
        echo "âœ… Service is healthy and responsive"
        echo "ğŸ“Š Performance metrics collected"
        
    - name: Failure notification
      if: failure()
      run: |
        echo "âŒ Synthetic tests failed!"
        echo "ğŸš¨ Service may be down or experiencing issues"
        # You could add Slack/Discord notifications here 